server {
    listen 80;
    server_name localhost;

    # =========================================================
    # 1. ASSETS DEL BACKEND (REGLAS FIJAS) - PRIORIDAD ALTA
    # =========================================================
    
    # CSS GLOBAL
    location = /css/layout.css {
        proxy_pass http://backend:80;
        proxy_set_header Host $host;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    
    location = /css/style.css {
        proxy_pass http://backend:80;
        proxy_set_header Host $host;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    # --- AQUÍ ESTÁ LA SOLUCIÓN ---
    # Forzamos que spot-detail vaya al backend sí o sí
    location = /css/spot-detail.css {
        proxy_pass http://backend:80;
        proxy_set_header Host $host;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }

    location = /js/spot-detail.js {
        proxy_pass http://backend:80;
        proxy_set_header Host $host;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
    }
    # -----------------------------

    # OTROS ASSETS DE LARAVEL (Regex general)
    location ~ ^/(css|js)/(dashboard|script|app|bootstrap|navigation|profile|explorer|favoritos|planes|spots)\.(css|js) { 
        proxy_pass http://backend:80;
        proxy_set_header Host $host;
    }

    # =========================================================
    # 2. CARPETA STORAGE Y VITE (Imágenes y Build)
    # =========================================================
    location /storage/ {
        proxy_pass http://backend:80;
        proxy_set_header Host $host;
    }

    location /build/ {
        proxy_pass http://backend:80;
        proxy_set_header Host $host;
    }

    # =========================================================
    # 3. API Y RUTAS WEB LARAVEL
    # =========================================================
    location /api/ {
        proxy_pass http://backend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Rutas específicas de Laravel
    location ~ ^/(login|register|dashboard|logout|password|email|sanctum|explorar|favoritos|planes|profile|spots|verify-email|confirm-password) {
        proxy_pass http://backend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # =========================================================
    # 4. FRONTEND (Landing Page)
    # =========================================================
    
    # Si no es ninguno de los anteriores, busca en el contenedor FRONTEND
    location /css/ {
        proxy_pass http://frontend:80;
    }
    location /js/ {
        proxy_pass http://frontend:80;
    }
    location /img/ {
        proxy_pass http://frontend:80;
    }

    location = / {
        proxy_pass http://frontend:80;
    }

    # =========================================================
    # 5. CATCH-ALL (Todo lo demás -> Backend)
    # =========================================================
    # Esto captura rutas dinámicas como /spots/1, /spots/5/edit, etc.
    location / {
        proxy_pass http://backend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}